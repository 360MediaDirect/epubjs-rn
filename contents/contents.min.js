(function(s,u){'object'==typeof exports&&'object'==typeof module?module.exports=u(require('xmldom')):'function'==typeof define&&define.amd?define(['xmldom'],u):'object'==typeof exports?exports.EPUBJSContents=u(require('xmldom')):s.EPUBJSContents=u(s.xmldom)})(this,function(t){return function(s){function u(f){if(p[f])return p[f].exports;var g=p[f]={exports:{},id:f,loaded:!1};return s[f].call(g.exports,g,g.exports,u),g.loaded=!0,g.exports}var p={};return u.m=s,u.c=p,u.p='',u(0)}([function(s,u,p){var f=p(1);s.exports=f},function(s,u,p){'use strict';function f(_){return _&&_.__esModule?_:{default:_}}function g(_,R){if(!(_ instanceof R))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(u,'__esModule',{value:!0});var y=function(){function _(R,L){for(var P=0;P<L.length;P++){var O=L[P];O.enumerable=O.enumerable||!1,O.configurable=!0,'value'in O&&(O.writable=!0),Object.defineProperty(R,O.key,O)}}return function(R,L,P){return L&&_(R.prototype,L),P&&_(R,P),R}}(),x=p(2),v=f(x),k=p(17),S=p(19),E=f(S),T=p(20),C=f(T),N=function(){function _(R,L,P){g(this,_),this.epubcfi=new E.default,this.document=R,this.documentElement=this.document.documentElement,this.content=L||this.document.body,this.window=this.document.defaultView,this.listenedEvents=['keydown','keyup','keypressed','mouseup','mousedown','click','touchend','touchstart'],this._size={width:0,height:0},this.cfiBase=P||'',this.listeners()}return y(_,[{key:'width',value:function(L){var P=this.content;return L&&(0,k.isNumber)(L)&&(L=L+'px'),L&&(P.style.width=L),this.window.getComputedStyle(P).width}},{key:'height',value:function(L){var P=this.content;return L&&(0,k.isNumber)(L)&&(L=L+'px'),L&&(P.style.height=L),this.window.getComputedStyle(P).height}},{key:'contentWidth',value:function(L){var P=this.content||this.document.body;return L&&(0,k.isNumber)(L)&&(L=L+'px'),L&&(P.style.width=L),this.window.getComputedStyle(P).width}},{key:'contentHeight',value:function(L){var P=this.content||this.document.body;return L&&(0,k.isNumber)(L)&&(L=L+'px'),L&&(P.style.height=L),this.window.getComputedStyle(P).height}},{key:'textWidth',value:function(){var L,P=this.document.createRange(),O=this.content||this.document.body;return P.selectNodeContents(O),L=P.getBoundingClientRect().width,L}},{key:'textHeight',value:function(){var L,P=this.document.createRange(),O=this.content||this.document.body;return P.selectNodeContents(O),L=P.getBoundingClientRect().height,L}},{key:'scrollWidth',value:function(){var L=this.documentElement.scrollWidth;return L}},{key:'scrollHeight',value:function(){var L=this.documentElement.scrollHeight;return L}},{key:'overflow',value:function(L){return L&&(this.documentElement.style.overflow=L),this.window.getComputedStyle(this.documentElement).overflow}},{key:'overflowX',value:function(L){return L&&(this.documentElement.style.overflowX=L),this.window.getComputedStyle(this.documentElement).overflowX}},{key:'overflowY',value:function(L){return L&&(this.documentElement.style.overflowY=L),this.window.getComputedStyle(this.documentElement).overflowY}},{key:'css',value:function(L,P){var O=this.content||this.document.body;return P&&(O.style[L]=P),this.window.getComputedStyle(O)[L]}},{key:'viewport',value:function(L){var P,O,B,z,W=this.document.querySelector('meta[name=\'viewport\']'),A='';if(W&&W.hasAttribute('content')){var I=W.getAttribute('content'),M=I.split(/\s*,\s*/);M[0]&&(P=M[0].replace('width=','').trim()),M[1]&&(O=M[1].replace('height=','').trim()),M[2]&&(B=M[2].replace('initial-scale=','').trim()),M[3]&&(z=M[3].replace('user-scalable=','').trim())}return L&&(A+='width='+(L.width||P),A+=', height='+(L.height||O),(L.scale||B)&&(A+=', initial-scale='+(L.scale||B)),(L.scalable||z)&&(A+=', user-scalable='+(L.scalable||z)),!W&&(W=this.document.createElement('meta'),W.setAttribute('name','viewport'),this.document.querySelector('head').appendChild(W)),W.setAttribute('content',A)),{width:parseInt(P),height:parseInt(O)}}},{key:'expand',value:function(){this.emit('expand')}},{key:'listeners',value:function(){this.imageLoadListeners(),this.mediaQueryListeners(),this.addEventListeners(),this.addSelectionListeners(),this.resizeListeners()}},{key:'removeListeners',value:function(){this.removeEventListeners(),this.removeSelectionListeners()}},{key:'resizeListeners',value:function(){var L,P;clearTimeout(this.expanding),L=this.scrollWidth(),P=this.scrollHeight(),(L!=this._size.width||P!=this._size.height)&&(this._size={width:L,height:P},this.emit('resize',this._size)),this.expanding=setTimeout(this.resizeListeners.bind(this),350)}},{key:'mediaQueryListeners',value:function(){var L=this.document.styleSheets,P=function(A){A.matches&&!this._expanding&&setTimeout(this.expand.bind(this),1)}.bind(this);for(var O=0;O<L.length;O+=1){var B;try{B=L[O].cssRules}catch(A){return}if(!B)return;for(var z=0;z<B.length;z+=1)if(B[z].media){var W=this.window.matchMedia(B[z].media.mediaText);W.addListener(P)}}}},{key:'observe',value:function(L){var P=this,O=new MutationObserver(function(){P._expanding&&P.expand()});return O.observe(L,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),O}},{key:'imageLoadListeners',value:function(){var P,L=this.document.querySelectorAll('img');for(var O=0;O<L.length;O++)P=L[O],'undefined'!=typeof P.naturalWidth&&0===P.naturalWidth&&(P.onload=this.expand.bind(this))}},{key:'fontLoadListeners',value:function(){this.document&&this.document.fonts&&this.document.fonts.ready.then(function(){this.expand()}.bind(this))}},{key:'root',value:function(){return this.document?this.document.documentElement:null}},{key:'locationOf',value:function(L,P){var O,B={left:0,top:0};if(this.document){if(this.epubcfi.isCfiString(L)){var z=new E.default(L).toRange(this.document,P);z&&(z.startContainer.nodeType===Node.ELEMENT_NODE?(O=z.startContainer.getBoundingClientRect(),B.left=O.left,B.top=O.top):(O=z.collapsed?z.getClientRects()[0]:z.getBoundingClientRect(),B.left=O.left,B.top=O.top))}else if('string'==typeof L&&-1<L.indexOf('#')){var W=L.substring(L.indexOf('#')+1),A=this.document.getElementById(W);A&&(O=A.getBoundingClientRect(),B.left=O.left,B.top=O.top)}return B}}},{key:'addStylesheet',value:function(L){return new Promise(function(P){var O,B=!1;return this.document?(O=this.document.querySelector('link[href=\''+L+'\']'),O?void P(!0):void(O=this.document.createElement('link'),O.type='text/css',O.rel='stylesheet',O.href=L,O.onload=O.onreadystatechange=function(){B||this.readyState&&'complete'!=this.readyState||(B=!0,setTimeout(function(){P(!0)},1))},this.document.head.appendChild(O))):void P(!1)}.bind(this))}},{key:'addStylesheetRules',value:function(L){var P,O,B='epubjs-inserted-css';if(this.document){P=this.document.getElementById('#'+B),P||(P=this.document.createElement('style'),P.id=B),this.document.head.appendChild(P),O=P.sheet;for(var z=0,W=L.length;z<W;z++){var A=1,I=L[z],M=L[z][0],D='';'[object Array]'===Object.prototype.toString.call(I[1][0])&&(I=I[1],A=0);for(var F=I.length;A<F;A++){var H=I[A];D+=H[0]+':'+H[1]+(H[2]?' !important':'')+';\n'}O.insertRule(M+'{'+D+'}',O.cssRules.length)}}}},{key:'addScript',value:function(L){return new Promise(function(P){var O,B=!1;return this.document?void(O=this.document.createElement('script'),O.type='text/javascript',O.async=!0,O.src=L,O.onload=O.onreadystatechange=function(){B||this.readyState&&'complete'!=this.readyState||(B=!0,setTimeout(function(){P(!0)},1))},this.document.head.appendChild(O)):void P(!1)}.bind(this))}},{key:'addClass',value:function(L){var P;this.document&&(P=this.content||this.document.body,P.classList.add(L))}},{key:'removeClass',value:function(L){var P;this.document&&(P=this.content||this.document.body,P.classList.remove(L))}},{key:'addEventListeners',value:function(){this.document&&this.listenedEvents.forEach(function(L){this.document.addEventListener(L,this.triggerEvent.bind(this),!1)},this)}},{key:'removeEventListeners',value:function(){this.document&&this.listenedEvents.forEach(function(L){this.document.removeEventListener(L,this.triggerEvent,!1)},this)}},{key:'triggerEvent',value:function(L){this.emit(L.type,L)}},{key:'addSelectionListeners',value:function(){this.document&&this.document.addEventListener('selectionchange',this.onSelectionChange.bind(this),!1)}},{key:'removeSelectionListeners',value:function(){this.document&&this.document.removeEventListener('selectionchange',this.onSelectionChange,!1)}},{key:'onSelectionChange',value:function(){this.selectionEndTimeout&&clearTimeout(this.selectionEndTimeout),this.selectionEndTimeout=setTimeout(function(){var L=this.window.getSelection();this.triggerSelectedEvent(L)}.bind(this),500)}},{key:'triggerSelectedEvent',value:function(L){var P,O;L&&0<L.rangeCount&&(P=L.getRangeAt(0),!P.collapsed&&(O=new E.default(P,this.cfiBase).toString(),this.emit('selected',O),this.emit('selectedRange',P)))}},{key:'range',value:function(L,P){var O=new E.default(L);return O.toRange(this.document,P)}},{key:'map',value:function(L){var R=new C.default(L);return R.section()}},{key:'size',value:function(L,P){0<=L&&this.width(L),0<=P&&this.height(P),this.css('margin','0'),this.css('boxSizing','border-box')}},{key:'columns',value:function(L,P,O,B){var z=(0,k.prefixed)('columnAxis'),W=(0,k.prefixed)('columnGap'),A=(0,k.prefixed)('columnWidth'),I=(0,k.prefixed)('columnFill');this.width(L),this.height(P),this.viewport({width:L,height:P,scale:1}),this.css('overflowY','hidden'),this.css('margin','0'),this.css('boxSizing','border-box'),this.css('maxWidth','inherit'),this.css(z,'horizontal'),this.css(I,'auto'),this.css(W,B+'px'),this.css(A,O+'px')}},{key:'scaler',value:function(L,P,O){var B='';this.css('transformOrigin','top left'),(0<=P||0<=O)&&(B=' translate('+(P||0)+'px, '+(O||0)+'px )'),this.css('transform','scale('+L+')'+B)}},{key:'fit',value:function(L,P){var O=this.viewport(),B=L/O.width,z=P/O.height,W=B<z?B:z,A=(P-O.height*W)/2;this.width(L),this.height(P),this.overflow('hidden'),this.viewport({scale:1}),this.scaler(W,0,A),this.css('backgroundColor','transparent')}},{key:'mapPage',value:function(L,P,O){var B=new C.default;return B.page(this,L,P,O)}},{key:'destroy',value:function(){this.observer&&this.observer.disconnect(),this.removeListeners()}}]),_}();(0,v.default)(N.prototype),u.default=N,s.exports=u['default']},function(s,u,p){'use strict';var C,N,_,R,L,P,O,f=p(3),g=p(16),y=Function.prototype.apply,x=Function.prototype.call,v=Object.create,k=Object.defineProperty,S=Object.defineProperties,E=Object.prototype.hasOwnProperty,T={configurable:!0,enumerable:!1,writable:!0};C=function(B,z){var W;return g(z),E.call(this,'__ee__')?W=this.__ee__:(W=T.value=v(null),k(this,'__ee__',T),T.value=null),W[B]?'object'==typeof W[B]?W[B].push(z):W[B]=[W[B],z]:W[B]=z,this},N=function(B,z){var W,A;return g(z),A=this,C.call(this,B,W=function(){_.call(A,B,W),y.call(z,this,arguments)}),W.__eeOnceListener__=z,this},_=function(B,z){var W,A,I,M;if(g(z),!E.call(this,'__ee__'))return this;if(W=this.__ee__,!W[B])return this;if(A=W[B],'object'==typeof A)for(M=0;I=A[M];++M)(I===z||I.__eeOnceListener__===z)&&(2===A.length?W[B]=A[M?0:1]:A.splice(M,1));else(A===z||A.__eeOnceListener__===z)&&delete W[B];return this},R=function(B){var z,W,A,I,M;if(E.call(this,'__ee__')&&(I=this.__ee__[B],I))if('object'==typeof I){for(W=arguments.length,M=Array(W-1),z=1;z<W;++z)M[z-1]=arguments[z];for(I=I.slice(),z=0;A=I[z];++z)y.call(A,this,M)}else switch(arguments.length){case 1:x.call(I,this);break;case 2:x.call(I,this,arguments[1]);break;case 3:x.call(I,this,arguments[1],arguments[2]);break;default:for(W=arguments.length,M=Array(W-1),z=1;z<W;++z)M[z-1]=arguments[z];y.call(I,this,M);}},L={on:C,once:N,off:_,emit:R},P={on:f(C),once:f(N),off:f(_),emit:f(R)},O=S({},P),s.exports=u=function(B){return null==B?v(O):S(Object(B),P)},u.methods=L},function(s,u,p){'use strict';var v,f=p(4),g=p(11),y=p(12),x=p(13);v=s.exports=function(k,S){var E,T,C,N,_;return 2>arguments.length||'string'!=typeof k?(N=S,S=k,k=null):N=arguments[2],null==k?(E=C=!0,T=!1):(E=x.call(k,'c'),T=x.call(k,'e'),C=x.call(k,'w')),_={value:S,configurable:E,enumerable:T,writable:C},N?f(g(N),_):_},v.gs=function(k,S,E){var T,C,N,_;return'string'==typeof k?N=arguments[3]:(N=E,E=S,S=k,k=null),null==S?S=void 0:y(S)?null==E?E=void 0:!y(E)&&(N=E,E=void 0):(N=S,S=E=void 0),null==k?(T=!0,C=!1):(T=x.call(k,'c'),C=x.call(k,'e')),_={get:S,set:E,configurable:T,enumerable:C},N?f(g(N),_):_}},function(s,u,p){'use strict';s.exports=p(5)()?Object.assign:p(6)},function(s){'use strict';s.exports=function(){var p,u=Object.assign;return!('function'!=typeof u)&&(p={foo:'raz'},u(p,{bar:'dwa'},{trzy:'trzy'}),'razdwatrzy'===p.foo+p.bar+p.trzy)}},function(s,u,p){'use strict';var f=p(7),g=p(10),y=Math.max;s.exports=function(x,v){var k,S,T,E=y(arguments.length,2);for(x=Object(g(x)),T=function(C){try{x[C]=v[C]}catch(N){k||(k=N)}},S=1;S<E;++S)v=arguments[S],f(v).forEach(T);if(k!==void 0)throw k;return x}},function(s,u,p){'use strict';s.exports=p(8)()?Object.keys:p(9)},function(s){'use strict';s.exports=function(){try{return Object.keys('primitive'),!0}catch(u){return!1}}},function(s){'use strict';var u=Object.keys;s.exports=function(p){return u(null==p?p:Object(p))}},function(s){'use strict';s.exports=function(u){if(null==u)throw new TypeError('Cannot use null or undefined');return u}},function(s){'use strict';var u=Array.prototype.forEach,p=Object.create,f=function(g,y){for(var x in g)y[x]=g[x]};s.exports=function(){var g=p(null);return u.call(arguments,function(y){null==y||f(Object(y),g)}),g}},function(s){'use strict';s.exports=function(u){return'function'==typeof u}},function(s,u,p){'use strict';s.exports=p(14)()?String.prototype.contains:p(15)},function(s){'use strict';var u='razdwatrzy';s.exports=function(){return!('function'!=typeof u.contains)&&!0===u.contains('dwa')&&!1===u.contains('foo')}},function(s){'use strict';var u=String.prototype.indexOf;s.exports=function(p){return-1<u.call(this,p,arguments[1])}},function(s){'use strict';s.exports=function(u){if('function'!=typeof u)throw new TypeError(u+' is not a function');return u}},function(s,u,p){'use strict';function f(){var E=new Date().getTime(),T='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(C){var N=0|(E+16*Math.random())%16;return E=Math.floor(E/16),('x'==C?N:8|7&N).toString(16)});return T}function g(E){return!isNaN(parseFloat(E))&&isFinite(E)}function y(E,T,C,N,_){var O,R=N||0,L=_||T.length,P=parseInt(R+(L-R)/2);return(C||(C=function(z,W){return z>W?1:z<W?-1:z==W?0:void 0}),0>=L-R)?P:(O=C(T[P],E),1==L-R?0<O?P:P+1:0===O?P:-1===O?y(E,T,C,P,L):y(E,T,C,R,P))}function x(E,T,C,N,_){var O,R=N||0,L=_||T.length,P=parseInt(R+(L-R)/2);return(C||(C=function(z,W){return z>W?1:z<W?-1:z==W?0:void 0}),0>=L-R)?-1:(O=C(T[P],E),1==L-R?0===O?P:-1:0===O?P:-1===O?x(E,T,C,P,L):x(E,T,C,R,P))}function v(E,T){return'undefined'==typeof E.querySelector?E.getElementsByTagName(T):E.querySelectorAll(T)}function k(E,T,C){for(var N=document.createTreeWalker(E,C,null,!1),_=void 0;_=N.nextNode();)T(_)}function S(E,T){if(T(E))return!0;if(E=E.firstChild,E)do{var C=S(E,T);if(C)return!0;E=E.nextSibling}while(E)}Object.defineProperty(u,'__esModule',{value:!0}),u.isElement=function(T){return!!(T&&1==T.nodeType)},u.uuid=f,u.documentHeight=function(){return Math.max(document.documentElement.clientHeight,document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight)},u.isNumber=g,u.isFloat=function(T){return g(T)&&Math.floor(T)!==T},u.prefixed=function(T){var C=['Webkit','Moz','O','ms'],N=T[0].toUpperCase()+T.slice(1),_=C.length;if('undefined'==typeof document||'undefined'!=typeof document.body.style[T])return T;for(var R=0;R<_;R++)if('undefined'!=typeof document.body.style[C[R]+N])return C[R]+N;return T},u.defaults=function(T){for(var C=1,N=arguments.length;C<N;C++){var _=arguments[C];for(var R in _)void 0===T[R]&&(T[R]=_[R])}return T},u.extend=function(T){var C=[].slice.call(arguments,1);return C.forEach(function(N){N&&Object.getOwnPropertyNames(N).forEach(function(_){Object.defineProperty(T,_,Object.getOwnPropertyDescriptor(N,_))})}),T},u.insert=function(T,C,N){var _=y(T,C,N);return C.splice(_,0,T),_},u.locationOf=y,u.indexOfSorted=x,u.bounds=function(T){var C=window.getComputedStyle(T),N=0,_=0;return['width','paddingRight','paddingLeft','marginRight','marginLeft','borderRightWidth','borderLeftWidth'].forEach(function(R){N+=parseFloat(C[R])||0}),['height','paddingTop','paddingBottom','marginTop','marginBottom','borderTopWidth','borderBottomWidth'].forEach(function(R){_+=parseFloat(C[R])||0}),{height:_,width:N}},u.borders=function(T){var C=window.getComputedStyle(T),N=0,_=0;return['paddingRight','paddingLeft','marginRight','marginLeft','borderRightWidth','borderLeftWidth'].forEach(function(R){N+=parseFloat(C[R])||0}),['paddingTop','paddingBottom','marginTop','marginBottom','borderTopWidth','borderBottomWidth'].forEach(function(R){_+=parseFloat(C[R])||0}),{height:_,width:N}},u.windowBounds=function(){var T=window.innerWidth,C=window.innerHeight;return{top:0,left:0,right:T,bottom:C,width:T,height:C}},u.cleanStringForXpath=function(T){var C=T.match(/[^'"]+|['"]/g);return C=C.map(function(N){return'\''===N?'"\'"':'"'===N?'\'"\'':'\''+N+'\''}),'concat(\'\','+C.join(',')+')'},u.indexOfTextNode=function(T){var C=T.parentNode,N=C.childNodes,_,R=-1;for(var L=0;L<N.length&&(_=N[L],_.nodeType===Node.TEXT_NODE&&R++,_!=T);L++);return R},u.isXml=function(T){return-1<['xml','opf','ncx'].indexOf(T)},u.createBlob=function(T,C){return new Blob([T],{type:C})},u.createBlobUrl=function(T,C){var _,N=window.URL||window.webkitURL||window.mozURL,R=this.createBlob(T,C);return _=N.createObjectURL(R),_},u.createBase64Url=function(T,C){var N,_;if('string'==typeof T)return N=btoa(T),_='data:'+C+';base64,'+N,_},u.type=function(T){return Object.prototype.toString.call(T).slice(8,-1)},u.parse=function(T,C,N){var _,R;return R='undefined'==typeof DOMParser||N?p(18).DOMParser:DOMParser,_=new R().parseFromString(T,C),_},u.qs=function(T,C){var N;if(!T)throw new Error('No Element Provided');return'undefined'==typeof T.querySelector?(N=T.getElementsByTagName(C),N.length)?N[0]:void 0:T.querySelector(C)},u.qsa=v,u.qsp=function(T,C,N){var _,R;if('undefined'!=typeof T.querySelector){for(var L in C+='[',N)C+=L+'=\''+N[L]+'\'';return C+=']',T.querySelector(C)}return(_=T.getElementsByTagName(C),R=Array.prototype.slice.call(_,0).filter(function(P){for(var O in N)if(P.getAttribute(O)===N[O])return!0;return!1}),R)?R[0]:void 0},u.sprint=function(T,C){var N=T.ownerDocument||T;'undefined'==typeof N.createTreeWalker?S(T,function(_){_&&3===_.nodeType&&C(_)},!0):k(T,C,NodeFilter.SHOW_TEXT)},u.treeWalker=k,u.walk=S,u.blob2base64=function(T,C){var N=new FileReader;N.readAsDataURL(T),N.onloadend=function(){C(N.result)}},u.defer=function(){var T=this;this.resolve=null,this.reject=null,this.id=f(),this.promise=new Promise(function(C,N){T.resolve=C,T.reject=N}),Object.freeze(this)},u.querySelectorByType=function(T,C,N){var _;if('undefined'!=typeof T.querySelector&&(_=T.querySelector(C+'[*|type="'+N+'"]')),!_||0===_.length){_=v(T,C);for(var R=0;R<_.length;R++)if(_[R].getAttributeNS('http://www.idpf.org/2007/ops','type')===N)return _[R]}else return _},u.findChildren=function(T){var C=[],N=T.parentNode.childNodes;for(var _=0;_<N.length;_++){var R=N[_];1===R.nodeType&&C.push(R)}return C},u.requestAnimationFrame='undefined'!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame)},function(s){s.exports=t},function(s,u,p){'use strict';function f(E,T){if(!(E instanceof T))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(u,'__esModule',{value:!0});var g='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(E){return typeof E}:function(E){return E&&'function'==typeof Symbol&&E.constructor===Symbol&&E!==Symbol.prototype?'symbol':typeof E},y=function(){function E(T,C){for(var N=0;N<C.length;N++){var _=C[N];_.enumerable=_.enumerable||!1,_.configurable=!0,'value'in _&&(_.writable=!0),Object.defineProperty(T,_.key,_)}}return function(T,C,N){return C&&E(T.prototype,C),N&&E(T,N),T}}(),x=p(17),v=1,k=3,S=function(){function E(T,C,N){f(this,E);var _;if(this.str='',this.base={},this.spinePos=0,this.range=!1,this.path={},this.start=null,this.end=null,!(this instanceof E))return new E(T,C,N);if('string'==typeof C?this.base=this.parseComponent(C):'object'===('undefined'==typeof C?'undefined':g(C))&&C.steps&&(this.base=C),_=this.checkType(T),'string'===_)return this.str=T,(0,x.extend)(this,this.parse(T));if('range'===_)return(0,x.extend)(this,this.fromRange(T,this.base,N));if('node'===_)return(0,x.extend)(this,this.fromNode(T,this.base,N));if('EpubCFI'===_&&T.path)return T;if(!T)return this;throw new TypeError('not a valid argument for EpubCFI')}return y(E,[{key:'checkType',value:function(C){return this.isCfiString(C)?'string':'object'===('undefined'==typeof C?'undefined':g(C))&&('Range'===(0,x.type)(C)||'undefined'!=typeof C.startContainer)?'range':'object'===('undefined'==typeof C?'undefined':g(C))&&'undefined'!=typeof C.nodeType?'node':'object'===('undefined'==typeof C?'undefined':g(C))&&C instanceof E&&'EpubCFI'}},{key:'parse',value:function(C){var _,R,L,N={spinePos:-1,range:!1,base:{},path:{},start:null,end:null};return'string'==typeof C?(0===C.indexOf('epubcfi(')&&')'===C[C.length-1]&&(C=C.slice(8,C.length-1)),_=this.getChapterComponent(C),!_)?{spinePos:-1}:(N.base=this.parseComponent(_),R=this.getPathComponent(C),N.path=this.parseComponent(R),L=this.getRange(C),L&&(N.range=!0,N.start=this.parseComponent(L[0]),N.end=this.parseComponent(L[1])),N.spinePos=N.base.steps[1].index,N):{spinePos:-1}}},{key:'parseComponent',value:function(C){var L,N={steps:[],terminal:{offset:null,assertion:null}},_=C.split(':'),R=_[0].split('/');return 1<_.length&&(L=_[1],N.terminal=this.parseTerminal(L)),''===R[0]&&R.shift(),N.steps=R.map(function(P){return this.parseStep(P)}.bind(this)),N}},{key:'parseStep',value:function(C){var N,_,R,L,P;if(L=C.match(/\[(.*)\]/),L&&L[1]&&(P=L[1]),_=parseInt(C),!isNaN(_))return 0==_%2?(N='element',R=_/2-1):(N='text',R=(_-1)/2),{type:N,index:R,id:P||null}}},{key:'parseTerminal',value:function(C){var N,_,R=C.match(/\[(.*)\]/);return R&&R[1]?(N=parseInt(C.split('[')[0])||null,_=R[1]):N=parseInt(C)||null,{offset:N,assertion:_}}},{key:'getChapterComponent',value:function(C){var N=C.split('!');return N[0]}},{key:'getPathComponent',value:function(C){var N=C.split('!');if(N[1]){var _=N[1].split(',');return _[0]}}},{key:'getRange',value:function(C){var N=C.split(',');return 3===N.length&&[N[1],N[2]]}},{key:'getCharecterOffsetComponent',value:function(C){var N=C.split(':');return N[1]||''}},{key:'joinSteps',value:function(C){return C?C.map(function(N){var _='';return'element'===N.type&&(_+=2*(N.index+1)),'text'===N.type&&(_+=1+2*N.index),N.id&&(_+='['+N.id+']'),_}).join('/'):''}},{key:'segmentString',value:function(C){var T='/';return T+=this.joinSteps(C.steps),C.terminal&&null!=C.terminal.offset&&(T+=':'+C.terminal.offset),C.terminal&&null!=C.terminal.assertion&&(T+='['+C.terminal.assertion+']'),T}},{key:'toString',value:function(){var C='epubcfi(';return C+=this.segmentString(this.base),C+='!',C+=this.segmentString(this.path),this.start&&(C+=',',C+=this.segmentString(this.start)),this.end&&(C+=',',C+=this.segmentString(this.end)),C+=')',C}},{key:'compare',value:function(C,N){var _,R,L,P;if('string'==typeof C&&(C=new E(C)),'string'==typeof N&&(N=new E(N)),C.spinePos>N.spinePos)return 1;if(C.spinePos<N.spinePos)return-1;C.range?(_=C.path.steps.concat(C.start.steps),L=C.start.terminal):(_=C.path.steps,L=C.path.terminal),N.range?(R=N.path.steps.concat(N.start.steps),P=N.start.terminal):(R=N.path.steps,P=N.path.terminal);for(var O=0;O<_.length;O++){if(!_[O])return-1;if(!R[O])return 1;if(_[O].index>R[O].index)return 1;if(_[O].index<R[O].index)return-1}return _.length<R.length?1:L.offset>P.offset?1:L.offset<P.offset?-1:0}},{key:'step',value:function(C){var N=C.nodeType===k?'text':'element';return{id:C.id,tagName:C.tagName,type:N,index:this.position(C)}}},{key:'filteredStep',value:function(C,N){var R,_=this.filter(C,N);if(_)return R=_.nodeType===k?'text':'element',{id:_.id,tagName:_.tagName,type:R,index:this.filteredPosition(_,N)}}},{key:'pathTo',value:function(C,N,_){for(var P,R={steps:[],terminal:{offset:null,assertion:null}},L=C;L&&L.parentNode&&9!=L.parentNode.nodeType;)P=_?this.filteredStep(L,_):this.step(L),P&&R.steps.unshift(P),L=L.parentNode;return null!=N&&0<=N&&(R.terminal.offset=N,'text'!=R.steps[R.steps.length-1].type&&R.steps.push({type:'text',index:0})),R}},{key:'equalStep',value:function(C,N){return C&&N&&C.index===N.index&&C.id===N.id&&C.type===N.type}},{key:'fromRange',value:function(C,N,_){var R={range:!1,base:{},path:{},start:null,end:null},L=C.startContainer,P=C.endContainer,O=C.startOffset,B=C.endOffset,z=!1;if(_&&(z=null!=L.ownerDocument.querySelector('.'+_)),'string'==typeof N?(R.base=this.parseComponent(N),R.spinePos=R.base.steps[1].index):'object'===('undefined'==typeof N?'undefined':g(N))&&(R.base=N),C.collapsed)z&&(O=this.patchOffset(L,O,_)),R.path=this.pathTo(L,O,_);else{R.range=!0,z&&(O=this.patchOffset(L,O,_)),R.start=this.pathTo(L,O,_),z&&(B=this.patchOffset(P,B,_)),R.end=this.pathTo(P,B,_),R.path={steps:[],terminal:null};var A,W=R.start.steps.length;for(A=0;A<W&&this.equalStep(R.start.steps[A],R.end.steps[A]);A++)A===W-1?R.start.terminal===R.end.terminal&&(R.path.steps.push(R.start.steps[A]),R.range=!1):R.path.steps.push(R.start.steps[A]);R.start.steps=R.start.steps.slice(R.path.steps.length),R.end.steps=R.end.steps.slice(R.path.steps.length)}return R}},{key:'fromNode',value:function(C,N,_){var R={range:!1,base:{},path:{},start:null,end:null};return'string'==typeof N?(R.base=this.parseComponent(N),R.spinePos=R.base.steps[1].index):'object'===('undefined'==typeof N?'undefined':g(N))&&(R.base=N),R.path=this.pathTo(C,null,_),R}},{key:'filter',value:function(C,N){var _,R,L,P,O,B=!1;return(C.nodeType===k?(B=!0,L=C.parentNode,_=C.parentNode.classList.contains(N)):(B=!1,_=C.classList.contains(N)),_&&B)?(P=L.previousSibling,O=L.nextSibling,P&&P.nodeType===k?R=P:O&&O.nodeType===k&&(R=O),R)?R:C:_&&!B?!1:C}},{key:'patchOffset',value:function(C,N,_){if(C.nodeType!=k)throw new Error('Anchor must be a text node');var R=C,L=N;for(C.parentNode.classList.contains(_)&&(R=C.parentNode);R.previousSibling;){if(R.previousSibling.nodeType!==v)L+=R.previousSibling.textContent.length;else if(R.previousSibling.classList.contains(_))L+=R.previousSibling.textContent.length;else break;R=R.previousSibling}return L}},{key:'normalizedMap',value:function(C,N,_){var P,B,z,R={},L=-1,O=C.length;for(P=0;P<O;P++)B=C[P].nodeType,B===v&&C[P].classList.contains(_)&&(B=k),0<P&&B===k&&z===k?R[P]=L:N===B&&(L=L+1,R[P]=L),z=B;return R}},{key:'position',value:function(C){var N,_;return C.nodeType===v?(N=C.parentNode.children,!N&&(N=(0,x.findChildren)(C.parentNode)),_=Array.prototype.indexOf.call(N,C)):(N=this.textNodes(C.parentNode),_=N.indexOf(C)),_}},{key:'filteredPosition',value:function(C,N){var _,R,L;return C.nodeType===v?(_=C.parentNode.children,L=this.normalizedMap(_,v,N)):(_=C.parentNode.childNodes,C.parentNode.classList.contains(N)&&(C=C.parentNode,_=C.parentNode.childNodes),L=this.normalizedMap(_,k,N)),R=Array.prototype.indexOf.call(_,C),L[R]}},{key:'stepsToXpath',value:function(C){var N=['.','*'];return C.forEach(function(_){var R=_.index+1;_.id?N.push('*[position()='+R+' and @id=\''+_.id+'\']'):'text'===_.type?N.push('text()['+R+']'):N.push('*['+R+']')}),N.join('/')}},{key:'stepsToQuerySelector',value:function(C){var N=['html'];return C.forEach(function(_){var R=_.index+1;_.id?N.push('#'+_.id):'text'!==_.type&&N.push('*:nth-child('+R+')')}),N.join('>')}},{key:'textNodes',value:function(C,N){return Array.prototype.slice.call(C.childNodes).filter(function(_){return _.nodeType===k||N&&_.classList.contains(N)})}},{key:'walkToNode',value:function(C,N,_){var P,B,R=N||document,L=R.documentElement,O=C.length;for(B=0;B<O;B++)P=C[B],'element'===P.type?L=L.children[P.index]:'text'===P.type&&(L=this.textNodes(L,_)[P.index]);return L}},{key:'findNode',value:function(C,N,_){var L,P,R=N||document;return _||'undefined'==typeof R.evaluate?_?L=this.walkToNode(C,R,_):L=this.walkToNode(C,R):(P=this.stepsToXpath(C),L=R.evaluate(P,R,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue),L}},{key:'fixMiss',value:function(C,N,_,R){var B,z,L=this.findNode(C.slice(0,-1),_,R),P=L.childNodes,O=this.normalizedMap(P,k,R),W=C[C.length-1].index;for(var A in O){if(!O.hasOwnProperty(A))return;if(O[A]===W)if(B=P[A],z=B.textContent.length,N>z)N=N-z;else{L=B.nodeType===v?B.childNodes[0]:B;break}}return{container:L,offset:N}}},{key:'toRange',value:function(C,N){var L,P,O,B,W,A,M,_=C||document,R=_.createRange(),z=this,I=!!N&&null!=_.querySelector('.'+N);if(z.range?(L=z.start,W=z.path.steps.concat(L.steps),O=this.findNode(W,_,I?N:null),P=z.end,A=z.path.steps.concat(P.steps),B=this.findNode(A,_,I?N:null)):(L=z.path,W=z.path.steps,O=this.findNode(z.path.steps,_,I?N:null)),O)try{null==L.terminal.offset?R.setStart(O,0):R.setStart(O,L.terminal.offset)}catch(D){M=this.fixMiss(W,L.terminal.offset,_,I?N:null),R.setStart(M.container,M.offset)}else return null;if(B)try{null==P.terminal.offset?R.setEnd(B,0):R.setEnd(B,P.terminal.offset)}catch(D){M=this.fixMiss(A,z.end.terminal.offset,_,I?N:null),R.setEnd(M.container,M.offset)}return R}},{key:'isCfiString',value:function(C){return'string'==typeof C&&0===C.indexOf('epubcfi(')&&')'===C[C.length-1]}},{key:'generateChapterComponent',value:function(C,N,_){var R=parseInt(N),L='/'+(C+1)+'/';return L+=2*(R+1),_&&(L+='['+_+']'),L}}]),E}();u.default=S,s.exports=u['default']},function(s,u,p){'use strict';function f(k,S){if(!(k instanceof S))throw new TypeError('Cannot call a class as a function')}Object.defineProperty(u,'__esModule',{value:!0});var g=function(){function k(S,E){for(var T=0;T<E.length;T++){var C=E[T];C.enumerable=C.enumerable||!1,C.configurable=!0,'value'in C&&(C.writable=!0),Object.defineProperty(S,C.key,C)}}return function(S,E,T){return E&&k(S.prototype,E),T&&k(S,T),S}}(),y=p(19),x=function(S){return S&&S.__esModule?S:{default:S}}(y),v=function(){function k(S){f(this,k),this.layout=S}return g(k,[{key:'section',value:function(E){var T=this.findRanges(E),C=this.rangeListToCfiList(E.section.cfiBase,T);return C}},{key:'page',value:function(E,T,C,N){var _=E&&E.document&&E.document.body;return _?this.rangePairToCfiPair(T,{start:this.findStart(_,C,N),end:this.findEnd(_,C,N)}):void 0}},{key:'walk',value:function(E,T){for(var N,_,C=document.createTreeWalker(E,NodeFilter.SHOW_TEXT,{acceptNode:function(L){return 0<L.data.trim().length?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);(N=C.nextNode())&&(_=T(N),!_););return _}},{key:'findRanges',value:function(E){var L,P,T=[],C=E.contents.scrollWidth(),N=this.layout.count(C),_=this.layout.column,R=this.layout.gap;for(var O=0;O<N.pages;O++)L=(_+R)*O,P=_*(O+1)+R*O,T.push({start:this.findStart(E.document.body,L,P),end:this.findEnd(E.document.body,L,P)});return T}},{key:'findStart',value:function(E,T,C){for(var _,R,N=[E],L=E;N.length;)if(_=N.shift(),R=this.walk(_,function(P){var O,B,z,W;return(P.nodeType==Node.TEXT_NODE?(W=document.createRange(),W.selectNodeContents(P),z=W.getBoundingClientRect()):z=P.getBoundingClientRect(),O=z.left,B=z.right,O>=T&&O<=C)?P:B>T?P:void(L=P,N.push(P))}),R)return this.findTextStartRange(R,T,C);return this.findTextStartRange(L,T,C)}},{key:'findEnd',value:function(E,T,C){for(var _,L,N=[E],R=E;N.length;)if(_=N.shift(),L=this.walk(_,function(P){var O,B,z,W;return(P.nodeType==Node.TEXT_NODE?(W=document.createRange(),W.selectNodeContents(P),z=W.getBoundingClientRect()):z=P.getBoundingClientRect(),O=z.left,B=z.right,O>C&&R)?R:B>C?P:void(R=P,N.push(P))}),L)return this.findTextEndRange(L,T,C);return this.findTextEndRange(R,T,C)}},{key:'findTextStartRange',value:function(E,T){var N,_,C=this.splitTextNodeIntoRanges(E);for(var R=0;R<C.length;R++)if(N=C[R],_=N.getBoundingClientRect(),_.left>=T)return N;return C[0]}},{key:'findTextEndRange',value:function(E,T,C){var _,R,L,N=this.splitTextNodeIntoRanges(E);for(var P=0;P<N.length;P++){if(R=N[P],L=R.getBoundingClientRect(),L.left>C&&_)return _;if(L.right>C)return R;_=R}return N[N.length-1]}},{key:'splitTextNodeIntoRanges',value:function(E,T){var R,C=[],N=E.textContent||'',_=N.trim(),L=E.ownerDocument,P=T||' ',O=_.indexOf(P);if(-1===O||E.nodeType!=Node.TEXT_NODE)return R=L.createRange(),R.selectNodeContents(E),[R];for(R=L.createRange(),R.setStart(E,0),R.setEnd(E,O),C.push(R),R=!1;-1!=O;)O=_.indexOf(P,O+1),0<O&&(R&&(R.setEnd(E,O),C.push(R)),R=L.createRange(),R.setStart(E,O+1));return R&&(R.setEnd(E,_.length),C.push(R)),C}},{key:'rangePairToCfiPair',value:function(E,T){var C=T.start,N=T.end;C.collapse(!0),N.collapse(!0);var _=new x.default(C,E).toString(),R=new x.default(N,E).toString();return{start:_,end:R}}},{key:'rangeListToCfiList',value:function(E,T){var N,C=[];for(var _=0;_<T.length;_++)N=this.rangePairToCfiPair(E,T[_]),C.push(N);return C}}]),k}();u.default=v,s.exports=u['default']}])});